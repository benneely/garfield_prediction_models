library(shiny)
library(ggplot2)
library(scales)
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
#Additional functions needed for this app
#Function needed in server.R to coerce user input to numeric data.frame
#Convert xml objects to data.frame
applyTransformations <- function(x) {
  if (names(x)=="sbp") {
    if (x < 120) {
      return(120)
    } else { 
      return(x) 
    }
  } else {
    return(x)
  }
}

checkandconvert <- function(x) {
  if (betaType[names(unlist(x))]=="continuous") {return (as.numeric(x))} 
  else if (betaType[names(unlist(x))]=="categorical") {
      if (names(unlist(x))=="country") {
        result = c("Australia"=0,"Austria"=0,"Belgium"=0,"Brazil"=0,"Canada"=0,"Chile"=0,"Denmark"=0,"Spain"=0,"Finland"=0,"UK"=0,"Hungary"=0,"Italy"=0,
                   "Korea"=0,"Netherlands"=0,"Norway"=0,"Thailand"=0,"USA"=0)
        indx = which(x==names(result))
        result[indx]=1
        return(result)
      } else {
          if (x=="Yes") { 
            result = eval(parse(text=paste0('c("',names(unlist(x)),'"=1)')))
            return(result)
          } else { 
            result = eval(parse(text=paste0('c("',names(unlist(x)),'"=0)')))
            return(result)
          }
    } 
  }
} 
   #%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  #Establish a connection with the database
  #%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  #Let's put together a xml object so that we can use certain functions to parse
  #allFiles <- list.files()
  #pmmlFiles <- allFiles[grep('*.pmml',allFiles)]
  #xmlfile <- xmlParse(pmmlFiles[[1]])
  #xmltop <- xmlRoot(xmlfile) #gives content of root
  #%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  #Get data elements in R friendly formats (i.e. data.frames / numeric vectors)
  #dict <- xmltop[["DataDictionary"]]
  referencePoints <- c("age"=60,"vascular_disease"=0,"ckd"=0)
  betaType <- c("age"="continuous","vascular_disease"="categorical","ckd"="categorical")
  betas <- c("age"=0.042943,"vascular_disease"=0.42205,"ckd"=0.60985)
  upper = c("age"=90) #c("age"=105,"sbp"=270,"dpb"=180)
  lower = c("age"=19) #c("age"=18,"sbp"=40,"dbp"=26)
  time <- c(0,1,2,3,4,5,6,9,10,11,12,13,15,16,18,20,21,23,24,26,29,30,31,32,34,35,36,39,40,42,46,47,48,49,51,52,54,56,57,59,65,68,69,70,71,72,74,75,78,80,82,83,84,85,86,88,89,90,93,
            98,99,101,102,103,104,106,107,108,109,110,111,112,113,114,115,116,119,120,122,123,124,125,126,131,133,137,138,141,148,152,154,157,158,159,160,161,162,163,164,166,168,
            171,175,176,182,184,187,188,192,193,196,198,202,205,206,212,214,216,219,222,223,228,229,231,232,235,236,237,244,246,247,248,250,254,258,259,260,261,262,268,271,272,273,
            275,276,280,281,282,283,284,285,286,291,295,296,298,300,301,303,305,307,310,313,314,317,320,322,323,330,332,334,335,338,339,342,344,350,352,353,355,356,357,359,360,361,365)
  baseHaz <- c(1,0.999980813,0.999961626,0.999903961,0.999865498,0.999846261,0.999827019,0.999788501,0.999730702,0.999711426,0.999672869,0.999615009,0.999557102,0.999537787,
               0.999518465,0.999479807,0.999421806,0.999344431,0.999325077,0.999286351,0.999266974,0.999228202,0.999170034,0.999131241,0.999111837,0.99905361,0.999014776,
               0.998995343,0.998975906,0.998956465,0.998898096,0.998878633,0.998859169,0.998839699,0.998820223,0.998781267,0.998742293,0.998722799,0.9987033,0.998683795,
               0.998625214,0.998605682,0.998586147,0.99854706,0.998507962,0.998488409,0.998468851,0.99844929,0.998429711,0.998390542,0.998351346,0.998312137,0.998292525,
               0.998214058,0.998194433,0.998174806,0.998135543,0.998115903,0.998096243,0.998056841,0.998017424,0.997977975,0.997958243,0.997938501,0.997918757,0.997879252,
               0.99785949,0.997839719,0.99780016,0.997780377,0.997760589,0.997740788,0.99772098,0.997701159,0.997681328,0.997661485,0.997621738,0.997562083,0.997522238,
               0.997502297,0.99746236,0.997442373,0.99742238,0.997402366,0.997382345,0.997362292,0.997342231,0.997322159,0.997302043,0.997281915,0.997241647,0.997201341,
               0.997161028,0.997120708,0.997100546,0.997060212,0.997040042,0.996979524,0.996959343,0.996918968,0.996898769,0.996878556,0.996838107,0.996817879,0.996797629,
               0.996777372,0.996757106,0.996736837,0.99671656,0.996676004,0.996655716,0.996635422,0.996615114,0.99659479,0.996554132,0.996513407,0.996472641,0.996452243,
               0.99641141,0.996390971,0.996350085,0.996329596,0.996268085,0.996247556,0.996206486,0.996185918,0.996165342,0.996144751,0.996124064,0.996103282,0.996061665,
               0.996020024,0.995957519,0.99593666,0.995894917,0.995874042,0.995853158,0.995832269,0.995811371,0.995790442,0.99574857,0.995685748,0.995664801,0.995643834,
               0.995601889,0.995580889,0.995538883,0.995517878,0.995496871,0.995475859,0.995454844,0.995433823,0.995412786,0.995370677,0.995328558,0.995307496,0.995286427,
               0.995265354,0.99524427,0.995202097,0.995181001,0.995159892,0.995138775,0.995096527,0.995075394,0.995054249,0.995033095,0.99499078,0.994948291,0.994927,0.994905657,
               0.994862935,0.99484148,0.99481999,0.994798427,0.994776817,0.994755026,0.994733143,0.994711203,0.994667115,0.994622946,0.994578702,0.994556453,0.994534131,
               0.994511709,0.994488926)
  #Transformations
  title     <- "Garfield Bleeding Risk Model"