library(shiny)
library(ggplot2)
library(scales)
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
#Additional functions needed for this app
#Function needed in server.R to coerce user input to numeric data.frame
#Convert xml objects to data.frame
applyTransformations <- function(x) {
  if (names(x)=="sbp") {
    if (x < 120) {
      return(120)
    } else { 
      return(x) 
    }
  } else {
    return(x)
  }
}

checkandconvert <- function(x) {
  if (betaType[names(unlist(x))]=="continuous") {return (as.numeric(x))} 
  else if (betaType[names(unlist(x))]=="categorical") {
      if (names(unlist(x))=="country") {
        result = c("Australia"=0,"Austria"=0,"Belgium"=0,"Brazil"=0,"Canada"=0,"Chile"=0,"Denmark"=0,"Spain"=0,"Finland"=0,"UK"=0,"Hungary"=0,"Italy"=0,
                   "Korea"=0,"Netherlands"=0,"Norway"=0,"Thailand"=0,"USA"=0)
        indx = which(x==names(result))
        result[indx]=1
        return(result)
      } else if (names(unlist(x))=="black") {
        if (x=="Afro-Caribean, Mixed Race, Other") { 
          result = eval(parse(text=paste0('c("',names(unlist(x)),'"=1)')))
          return(result)
        } else { 
          result = eval(parse(text=paste0('c("',names(unlist(x)),'"=0)')))
          return(result)
        }
      } else {
          if (x=="Yes") { 
            result = eval(parse(text=paste0('c("',names(unlist(x)),'"=1)')))
            return(result)
          } else { 
            result = eval(parse(text=paste0('c("',names(unlist(x)),'"=0)')))
            return(result)
          }
    } 
  }
} 
   #%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  #Establish a connection with the database
  #%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  #Let's put together a xml object so that we can use certain functions to parse
  #allFiles <- list.files()
  #pmmlFiles <- allFiles[grep('*.pmml',allFiles)]
  #xmlfile <- xmlParse(pmmlFiles[[1]])
  #xmltop <- xmlRoot(xmlfile) #gives content of root
  #%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  #Get data elements in R friendly formats (i.e. data.frames / numeric vectors)
  #dict <- xmltop[["DataDictionary"]]
  referencePoints <- c("stroke"=0,"age"=60,"bleed"=0,"heart_failure"=0,"ckd"=0,"other_region"=0,"black"=0,"oral_anti"=0)
  betaType <- c("stroke"="categorical","age"="continuous","bleed"="categorical","heart_failure"="categorical","ckd"="categorical","other_region"="categorical","black"="categorical","oral_anti"="categorical")
  betas <- c("stroke"=0.952524717,"age"=0.03048226,"bleed"=0.432357326,"heart_failure"=0.319129628,"ckd"=0.574919171,"other_region"=0.654249546,"black"=0.671380382,"oral_anti"=-0.582045773)
  upper = c("age"=90) #c("age"=105,"sbp"=270,"dpb"=180)
  lower = c("age"=19) #c("age"=18,"sbp"=40,"dbp"=26)
  time <- c(0,1,2,3,4,5,6,8,9,10,11,12,13,14,16,17,19,20,21,22,23,24,26,27,28,29,30,31,32,33,34,35,38,40,41,42,43,44,45,47,48,52,53,54,56,57,58,59,61,62,63,64,65,66,67,68,69,70,
            72,73,74,76,77,78,80,82,83,84,85,86,89,90,91,93,94,96,97,98,99,100,101,102,103,104,105,106,108,109,110,111,112,113,114,115,116,117,118,119,122,123,124,125,126,127,128,
            129,130,131,132,133,134,135,136,137,138,139,141,143,145,146,147,148,149,151,152,155,156,158,159,160,161,162,163,164,165,166,167,168,169,170,171,173,174,175,176,177,178,
            179,181,182,183,185,186,187,190,194,195,197,199,201,202,203,204,205,208,210,211,212,213,215,216,218,220,221,223,224,225,226,227,233,234,235,236,237,238,239,240,241,242,
            244,245,246,249,251,255,256,257,258,259,260,261,262,263,264,266,268,272,273,274,275,276,277,279,280,281,282,283,286,287,288,289,290,292,293,294,295,299,306,307,311,312,
            314,315,316,317,318,320,323,325,326,327,328,331,332,334,336,338,339,342,343,345,346,348,350,351,352,353,354,356,358,361,362,363,364)
  baseHaz <- c(1,0.999813261,0.999762311,0.999745287,0.999677172,0.999609008,0.999557827,0.999472481,0.999438313,0.999369944,0.999284433,0.999233102,0.999215967,0.999181684,
               0.999147375,0.999095887,0.999061537,0.999009989,0.998992795,0.998941193,0.998906775,0.998889557,0.9988551,0.998837861,0.998820617,0.998803369,0.998786116,
               0.998768855,0.998734324,0.998699785,0.998647952,0.998578808,0.998544192,0.998509557,0.998492239,0.998457591,0.99837096,0.998336293,0.998318955,0.998284263,
               0.998249563,0.998162745,0.998127999,0.998075873,0.998006336,0.997988941,0.997971539,0.997954135,0.997919307,0.99790189,0.997867046,0.997832196,0.997797323,
               0.99777988,0.997710102,0.997675205,0.997622847,0.997570467,0.997535529,0.997500569,0.997465598,0.997448106,0.997430609,0.997413109,0.997343083,0.99732556,
               0.997308031,0.997290497,0.997272959,0.997237862,0.997220303,0.99718517,0.99715002,0.997132429,0.997097231,0.99707961,0.997061984,0.997044352,0.997026715,
               0.997009069,0.996956106,0.996920777,0.996885437,0.99686776,0.99685008,0.996832389,0.996779277,0.996743851,0.996726133,0.996708412,0.996690682,0.996672944,
               0.996637438,0.996619677,0.996601901,0.996566325,0.996548517,0.996477261,0.99642364,0.996298358,0.996226627,0.996208666,0.996172723,0.996136773,0.996118791,
               0.996100803,0.996082807,0.996010813,0.995992811,0.995920793,0.995902777,0.995884757,0.995866733,0.995830675,0.995776565,0.995758523,0.995722424,0.995704354,
               0.995686276,0.995632024,0.995613928,0.995595827,0.99557772,0.995559605,0.995541487,0.995505236,0.995468965,0.99543268,0.995414532,0.995378238,0.995360086,
               0.99532378,0.995305624,0.995287464,0.995269295,0.995232949,0.995196595,0.995160212,0.995123823,0.995087424,0.995051022,0.995032816,0.995014606,0.994941759,
               0.994923542,0.99486888,0.994850657,0.994795959,0.994777717,0.994759472,0.994741226,0.994668213,0.994649953,0.994631688,0.994613416,0.994595129,0.994576841,
               0.994521951,0.994485336,0.994448698,0.994430374,0.99439372,0.99437539,0.994357055,0.99433871,0.994302008,0.99424693,0.994228567,0.994191823,0.994173434,
               0.994118248,0.994099837,0.994081413,0.994026127,0.993989248,0.993970799,0.993952344,0.993933881,0.99387847,0.993859956,0.993841431,0.993804359,0.993785815,
               0.993748686,0.993730109,0.993692934,0.993637129,0.993618514,0.993599882,0.993543871,0.993525158,0.993506389,0.993449939,0.993431113,0.993412264,0.993393406,
               0.993374543,0.993355678,0.993317929,0.993299049,0.993280164,0.993242383,0.993204587,0.993166781,0.993147871,0.993110025,0.993091081,0.993072134,0.993034231,
               0.993015273,0.99299631,0.992958362,0.992939375,0.992920383,0.99290138,0.992863363,0.992844354,0.99280632,0.992787302,0.992768281,0.992749256,0.992730229,
               0.99271119,0.992673106,0.992654063,0.992635015,0.992615948,0.992577757,0.992539559,0.992501341,0.992482227,0.992463109,0.992443988,0.992424863,0.992405735,
               0.992386601,0.992348319,0.992329161,0.992309986,0.992290792,0.992271581,0.992252351,0.992213798,0.992194506,0.992175174,0.992117064,0.992097642,0.992078193,
               0.992039182,0.991941547,0.991902393,0.991843578,0.991764936,0.991745231,0.991685995,0.991646439,0.991586973,0.991547242,0.991527309,0.991507294,0.991487078,
               0.991466799,0.991426092,0.991344397)
  #Transformations
  title     <- "Garfield Bleeding Risk Model"